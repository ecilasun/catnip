# SimpleGame
# Neko sample code
# Compatible with architecture level 3

@ORG 0x0000
@LABEL main

# By default initial output VRAM page is #0 and writes go to VRAM page #1

# Clear display and set up border color for both VRAM pages
ld.w r0, 0x0000
fsel r0
ld.w r7, 0x00E0
clf r7
ld.w r5, 0x00B6
ld.d r1:r0, BORDERCOLOR
st.b [r1:r0], r5

ld.w r0, 0x0001
fsel r0
ld.w r7, 0x00E0
clf r7
ld.w r5, 0x00B6
ld.d r1:r0, BORDERCOLOR
st.b [r1:r0], r5

# Set video display to show VRAM page 0
ld.w r0, 0x0000
fsel r0

@LABEL ANIMATIONLOOP
# Save our vram output index
push r0

# Clear framebuffer
ld.w r7, 0x00E0
clf r7

# Set up tile entry count
lea r7:r6, TILE_HEADER
ld.w r5, [r7:r6]
# Set up tile data pointer
lea r7:r6, TILE_DATA
# Walk over each tile data entry and draw its sprite
@LABEL DRAWTILESET
    push r5
    ld.w r0, [r7:r6]
    push r0 # Y
    inc r6
    inc r6
    ld.w r0, [r7:r6]
    push r0 # X
    inc r6
    inc r6
    ld.w r0, [r7:r6]
    push r0 # Sprite#
    branch DrawSprite
    pop r5
    inc r6
    inc r6
    dec r5
    cmp r5, r5
    test notzero
jmpif DRAWTILESET

# Step animated tile positions for next time
lea r7:r6, ANIMATED_TILES
ld.w r5, [r7:r6]
inc r5
st.w [r7:r6], r5
ld.w r5, 0x0006
iadd r6,r5
ld.w r5, [r7:r6]
inc r5
st.w [r7:r6], r5

# Restore our VRAM page index
# Increment by one so that we show the page we just produced
pop r0
inc r0
fsel r0

jmp ANIMATIONLOOP

# Done, we can stop now
halt

# -------------------------------------------------------
# Draw a sprite at (r0,r1)
# -------------------------------------------------------

@LABEL DrawSprite

pop r5                   # Sprite #
pop r0                   # X
pop r1                   # Y

# Save all registers
push r0
push r1
push r2
push r3
push r4
push r5
push r6
push r7

ld.w r2, 0x0140          # Row pitch (320)
imul r1, r2              # Y*320
iadd r0, r1              # X+Y*320
ld.w r1, 0x8000          # 0x8000:(X+Y*320) == VRAM address

# Set up sprite address so that r3:r2 == (0000:0400 + spriteindex*256)
lea r3:r2, SPRITE_SHEET
ld.w r4, 0x0100
imul r5, r4              # spriteindex*256
iadd r2, r5

ld.w r4, 0x0010          # column counter (sprite is 16 pixels wide, but has 18 pixel stride)
ld.w r5, 0x0010          # row counter (16 pixels)

@LABEL INNERLOOP
    # for each column
        ld.b r6, [r3:r2]        # read from current pattern buffer location
        ld.w r7, 0x00FF         # compare sprite color with 0xFF (mask color)
        cmp r6, r7
        test equal
        jmpif SKIPWRITE         # ignore writes if it's the mask color
        st.b [r1:r0], r6	   	# write back to current VRAM location
        @LABEL SKIPWRITE

        inc r0	    	    	# increment VRAM pointer
        inc r2                  # increment pattern pointer
        dec r4		        	# decrement scanline counter
        cmp r4, r4 			    # compare to self + notzero test is a means to say 'r4!=0?'
        test notzero
    jmpif INNERLOOP             # repeat while we have more pixels on this row

    # for each row
    ld.w r4, 0x0010             # reset column counter back to 17
    ld.w r7, 0x0130             # set row stride (320-16==304)
    iadd r0, r7                 # move to next scanline
    dec r5
    cmp r5, r5
    test notzero
jmpif INNERLOOP                 # for each row

# Restore all registers
pop r7
pop r6
pop r5
pop r4
pop r3
pop r2
pop r1
pop r0

ret

# Some tables and other entries

@LABEL VRAMSTART
@DW 0x8000 0x0000

@LABEL BORDERCOLOR
@DW 0x8000 0xFF00

@LABEL TILE_HEADER
#   TileDataCount
@DW 0x006A

@LABEL TILE_DATA
#   YPos   XPos   Sprite
# Wall
@DW 0x0000 0x0000 0x0006
@DW 0x0000 0x0010 0x0006
@DW 0x0000 0x0020 0x0006
@DW 0x0000 0x0030 0x0006
@DW 0x0000 0x0040 0x0006
@DW 0x0000 0x0050 0x0006
@DW 0x0000 0x0060 0x0006
@DW 0x0000 0x0070 0x0006
@DW 0x0000 0x0080 0x0006
@DW 0x0000 0x0090 0x0006
@DW 0x0000 0x00A0 0x0006
@DW 0x0000 0x00B0 0x0006
@DW 0x0000 0x00C0 0x0006
@DW 0x0000 0x00D0 0x0006
@DW 0x0000 0x00E0 0x0006
@DW 0x0000 0x00F0 0x0006
@DW 0x0000 0x0100 0x0006
@DW 0x0000 0x0110 0x0006
@DW 0x0000 0x0120 0x0006
@DW 0x0000 0x0130 0x0006
# Wall
@DW 0x0010 0x0000 0x0006
@DW 0x0010 0x0010 0x0006
@DW 0x0010 0x0020 0x0006
@DW 0x0010 0x0030 0x0006
@DW 0x0010 0x0040 0x0006
@DW 0x0010 0x0050 0x0006
@DW 0x0010 0x0060 0x0006
@DW 0x0010 0x0070 0x0006
@DW 0x0010 0x0080 0x0006
@DW 0x0010 0x0090 0x0006
@DW 0x0010 0x00A0 0x0006
@DW 0x0010 0x00B0 0x0006
@DW 0x0010 0x00C0 0x0006
@DW 0x0010 0x00D0 0x0006
@DW 0x0010 0x00E0 0x0006
@DW 0x0010 0x00F0 0x0006
@DW 0x0010 0x0100 0x0006
@DW 0x0010 0x0110 0x0006
@DW 0x0010 0x0120 0x0006
@DW 0x0010 0x0130 0x0006
# Wall
@DW 0x0020 0x0000 0x0006
@DW 0x0020 0x0010 0x0006
@DW 0x0020 0x0020 0x0006
@DW 0x0020 0x0030 0x0006
@DW 0x0020 0x0040 0x0006
@DW 0x0020 0x0050 0x0006
@DW 0x0020 0x0060 0x0006
@DW 0x0020 0x0070 0x0006
@DW 0x0020 0x0080 0x0006
@DW 0x0020 0x0090 0x0006
@DW 0x0020 0x00A0 0x0006
@DW 0x0020 0x00B0 0x0006
@DW 0x0020 0x00C0 0x0006
@DW 0x0020 0x00D0 0x0006
@DW 0x0020 0x00E0 0x0006
@DW 0x0020 0x00F0 0x0006
@DW 0x0020 0x0100 0x0006
@DW 0x0020 0x0110 0x0006
@DW 0x0020 0x0120 0x0006
@DW 0x0020 0x0130 0x0006
# Wall
@DW 0x0030 0x0000 0x0006
@DW 0x0030 0x0010 0x0006
@DW 0x0030 0x0020 0x0006
@DW 0x0030 0x0030 0x0006
@DW 0x0030 0x0040 0x0006
@DW 0x0030 0x0050 0x0006
@DW 0x0030 0x0060 0x0006
@DW 0x0030 0x0070 0x0006
@DW 0x0030 0x0080 0x0006
@DW 0x0030 0x0090 0x0006
@DW 0x0030 0x00A0 0x0006
@DW 0x0030 0x00B0 0x0006
@DW 0x0030 0x00C0 0x0006
@DW 0x0030 0x00D0 0x0006
@DW 0x0030 0x00E0 0x0006
@DW 0x0030 0x00F0 0x0006
@DW 0x0030 0x0100 0x0006
@DW 0x0030 0x0110 0x0006
@DW 0x0030 0x0120 0x0006
@DW 0x0030 0x0130 0x0006
# Wall
@DW 0x0040 0x0000 0x0006
@DW 0x0040 0x0010 0x0006
@DW 0x0040 0x0020 0x0006
@DW 0x0040 0x0030 0x0006
@DW 0x0040 0x0040 0x0006
@DW 0x0040 0x0050 0x0006
@DW 0x0040 0x0060 0x0006
@DW 0x0040 0x0070 0x0006
@DW 0x0040 0x0080 0x0006
@DW 0x0040 0x0090 0x0006
@DW 0x0040 0x00A0 0x0006
@DW 0x0040 0x00B0 0x0006
@DW 0x0040 0x00C0 0x0006
@DW 0x0040 0x00D0 0x0006
@DW 0x0040 0x00E0 0x0006
@DW 0x0040 0x00F0 0x0006
@DW 0x0040 0x0100 0x0006
@DW 0x0040 0x0110 0x0006
@DW 0x0040 0x0120 0x0006
@DW 0x0040 0x0130 0x0006
# Computer desk
@DW 0x0000 0x0000 0x0000
@DW 0x0010 0x0000 0x0001
@DW 0x0000 0x0010 0x0002
@DW 0x0010 0x0010 0x0003
@LABEL ANIMATED_TILES
# Potted plant
@DW 0x000F 0x0015 0x0004
@DW 0x001F 0x0015 0x0005

# Sprite sheet (16x112, each sprite is 16x16 in size)
@LABEL SPRITE_SHEET
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0x0 0x0 0x0 0x0 0x0 0xFF 
@DW 0xFFFF 0xFF00 0xF69A 0x9A9A 0x9A9A 0x9A9A 0x9A9A 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5100 
@DW 0xFFFF 0xFF00 0x9A09 0x909 0x909 0x909 0x909 0x5151 
@DW 0xFFFF 0x100 0x5151 0x7272 0x5151 0x5151 0x4751 0x5151 
@DW 0xFF01 0x6F66 0x4949 0x4949 0x499A 0x4949 0x4949 0x4949 
@DW 0xFF01 0x6F6F 0x666F 0x6F6F 0x499A 0x496F 0x6F6F 0x6F6F 
@DW 0xFF01 0x6F6F 0x6F49 0x4949 0x4949 0x4949 0x4949 0x6F6F 
@DW 0xFF01 0x666F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 
@DW 0xFF01 0x6F66 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6666 0x6666 
@DW 0xFF01 0x6F6F 0x6F66 0x6666 0x6F6F 0x6F6F 0x6F6F 0x6F6F 
@DW 0xFF01 0x1414 0x1414 0x1414 0x1414 0x1414 0x1414 0x1414 
@DW 0xFFFF 0x101 0x101 0x101 0x101 0x101 0x101 0x101 
@DW 0xFFFF 0xFF00 0x5248 0x4848 0x4848 0x4848 0x4848 0x4848 
@DW 0xFFFF 0xFF00 0x5248 0x5252 0x5252 0x5252 0x5252 0x5252 
@DW 0xFFFF 0xFF00 0x5200 0x0 0x0 0x0 0x0 0x0 
@DW 0xFFFF 0xFF00 0x5200 0xA4A4 0xA4A4 0xA4A4 0xA4A4 0xA4A4 
@DW 0xFFFF 0xFF00 0x5200 0xA4A4 0xA4A4 0xA4A4 0xA4A4 0xA4A4 
@DW 0xFFFF 0xFF00 0x5200 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFF00 0x0 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFF00 0x0 0xFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xAC 0x9B9B 0x9B00 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xAC 0xACAC 0x9B00 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xAC 0xACAC 0xAC00 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xAC 0xACAC 0xAC00 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xF6 0xF6F6 0xF600 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0x9B 0x9B9B 0x9B00 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xAC 0x9B9B 0x4700 0xFFFF 0xFFFF 
@DW 0x0 0x0 0x0 0x9B 0x9B9B 0x9B00 0x101 0xFFFF 
@DW 0x6F6F 0x666F 0x6F6F 0x48AC 0x9BAC 0x9B48 0x6F66 0x1FF 
@DW 0x6F6F 0x6F66 0x666F 0x489B 0x9BAC 0x9B48 0x6F6F 0x1FF 
@DW 0x6F6F 0x6F6F 0x6F6F 0x489B 0x9BAC 0x9B48 0x6F6F 0x1FF 
@DW 0x6F6F 0x6F6F 0x6F6F 0x4848 0x4848 0x4848 0x6F66 0x1FF 
@DW 0x6F6F 0x6F6F 0x6666 0x6F6F 0x6F6F 0x6F6F 0x6F66 0x1FF 
@DW 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x6F6F 0x1FF 
@DW 0x1414 0x1414 0x1414 0x1414 0x1414 0x1414 0x1414 0xFF 
@DW 0x101 0x101 0x101 0x101 0x101 0x101 0x101 0xA4FF 
@DW 0x4848 0x4848 0x529B 0x9B9B 0x9B9B 0x9B52 0xA4 0xA4FF 
@DW 0x5252 0x5248 0x5252 0x5248 0x4852 0x5252 0xA4 0xA4FF 
@DW 0x0 0x0 0x529B 0x9B9B 0x9B9B 0x9B52 0xA4 0xA4FF 
@DW 0xA4A4 0xA400 0x5252 0x5248 0x4852 0x5252 0xA4 0xA4FF 
@DW 0xA4A4 0xA400 0x529B 0x9B9B 0x9B9B 0x9B52 0xA4 0xA4FF 
@DW 0xFFFF 0xFF00 0x5200 0x0 0x0 0x52 0xA4 0xA4FF 
@DW 0xFFFF 0xFF00 0x0 0xA4A4 0xA4A4 0x0 0xA4 0xA4FF 
@DW 0xFF08 0x8FF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0x872 0x7208 0x8FF 0xFFFF 0xFFFF 0x808 0x8FF 0xFFFF 
@DW 0x872 0x7C7C 0x7208 0xFFFF 0xFF08 0x7C7C 0x7208 0xFFFF 
@DW 0x861 0x7272 0x7261 0x8FF 0x872 0x7C7C 0x7272 0x8FF 
@DW 0xFF08 0x7272 0x7272 0x6108 0x6172 0x7272 0x7261 0x8FF 
@DW 0xFF08 0x6172 0x7272 0x7272 0x7272 0x7272 0x6108 0xFFFF 
@DW 0xFFFF 0x861 0x7272 0x7272 0x7272 0x7261 0x8FF 0xFFFF 
@DW 0xFFFF 0xFF08 0x861 0x7261 0x6108 0x808 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFF08 0x6161 0x8FF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0x101 0x108 0x6161 0x801 0x101 0xFFFF 0xFFFF 
@DW 0xFF01 0x5D67 0x6767 0x6161 0x6767 0x675D 0x1FF 0xFFFF 
@DW 0xFF01 0xB714 0x1414 0x6161 0x1414 0x1467 0x1FF 0xFFFF 
@DW 0xFF01 0xB714 0x5252 0x6161 0x5252 0x1467 0x1FF 0xFFFF 
@DW 0xFF01 0xB714 0x5252 0x5252 0x5252 0x1467 0x1FF 0xFFFF 
@DW 0xFF01 0x67B7 0xB7B7 0xB7B7 0xB7B7 0xB767 0x1FF 0xFFFF 
@DW 0xFF01 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x1FF 0xFFFF 
@DW 0xFF01 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x1FF 0xFFFF 
@DW 0xFF01 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x1FF 0xFFFF 
@DW 0xFFFF 0x101 0x101 0x101 0x101 0x101 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFF01 0x1414 0x1414 0x1414 0x1FF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFF01 0x1414 0x1414 0x1414 0x1FF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0x101 0x101 0x101 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 0xFFFF 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x6F6F 0x6F6F 0x546F 0x6F6F 0x6F6F 0x6F54 0x6F6F 0x6F6F 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x6F5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 
@DW 0x6F6F 0x6F6F 0x546F 0x6F6F 0x6F6F 0x6F54 0x6F6F 0x6F6F 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D 
@DW 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D5D 0x5D6F 0x5D5D 0x5D5D
